# 代码修复说明

## 修复内容

### 1. ThemeManager 类
- 添加了 `_background_image_path` 属性来保存背景图片路径
- 修复了 `_save_settings` 方法，添加 `blur_radius` 的保存
- 完善了背景图片管理功能

### 2. MainWindow 类

#### 方法顺序调整
- 将 `_get_message_style` 方法移到 `_wire_signals` 之前，避免在使用时未定义的错误
- 删除了重复的 `_get_message_style` 方法定义
- 确保所有 `on_` 事件处理方法在 `_wire_signals` 连接信号之前已定义

#### 方法修复
- **_get_message_style**: 提供主题相关的样式配置，支持浅色和深色主题
- **p2p_append_me**: 我发送的消息气泡样式
- **p2p_append_sys**: 系统消息样式
- **所有 on_xxx 方法**: 确保正确缩进为类方法

### 3. UI 相关修复
- 修复了 `_build_server_tab` 中的布局问题（QVBoxLayout 包装在 QWidget 中）
- 更新了消息显示，使用主题相关的动态样式
- 添加了主题切换按钮和设置对话框

### 4. 消息气泡样式
根据当前主题自动调整颜色：

**浅色主题**:
- 我的消息: 蓝色 (#3498db)
- 对方消息: 白色背景，带边框
- 系统消息: 浅灰色 (#e8ecef)

**深色主题**:
- 我的消息: 天蓝色 (#5dade2)
- 对方消息: 深灰色 (#16213e)
- 系统消息: 深蓝色 (#0f3460)

### 5. 文件路径问题修复
- 修复了 `_on_select_background` 中变量名错误（`bg_path_edit` -> `self.bg_path_edit`）

## 新增功能

### 主题管理
- ✅ 浅色/深色主题切换
- ✅ 自定义聊天背景图片
- ✅ 背景透明度调整
- ✅ 模糊半径设置（预留接口）
- ✅ 设置持久化存储

### 响应式布局
- ✅ Splitter 弹性布局
- ✅ 最小窗口尺寸限制
- ✅ 左右面板权重调整

## 使用说明

### 主题切换
1. 点击顶部 "🎨 主题" 按钮
2. 在对话框中选择浅色或深色主题
3. 调整背景图片和透明度（可选）
4. 点击关闭应用设置

### P2P 模式
- 输入对方 IP 地址和端口
- 点击 "开启主机" 或 "连接主机"
- 开始聊天或拖拽文件发送

### 服务器模式
- 输入服务器地址、端口和昵称
- 点击 "连接服务器"
- 选择或输入房间 ID
- 开始聊天（支持 @用户名 私聊）

## 文件结构
```
PyQt-P2P-Chat/
├── main.py           # 主程序（客户端）
├── server.py         # 服务器程序
├── style.qss         # 浅色主题样式
├── dark.qss          # 深色主题样式
└── README.md         # 说明文档
```
